# -*- coding: utf-8 -*-
"""CSV_result_processor-all.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1DmEBBRyRX2sLf7lXj8wXi-LmNm343Q1X

## CSV Results Processor

Graph results of climate prediction data captured via CSV data.
"""


debug = False

DRIVE_PATH = "/data/projects/data606"

# Set the location of this script in GDrive
SCRIPT_PATH = DRIVE_PATH + "/src/"

# Location of run data
JOURNAL_LOG = SCRIPT_PATH + "cv-results.csv"
DATA_ROOT = DRIVE_PATH + "/data/preds/"
# -- load a particular result set --
#DATA_ROOT = DRIVE_PATH + "/data/preds-s4/"
#JOURNAL_LOG = DATA_ROOT + "cv-results.csv"


# Colors for rendering
colors = 'rbygm'

# Visualization params
METRIC = 'MSE'

GROUP_COLS = ['TargetLabel','WindowSize','TestPct','Columns']
TGT_LABEL = 0
WIND_SIZE = 1
TEST_PCT = 2
COLS = 3

import glob
import os
import pandas as pd
from pathlib import Path
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
import matplotlib.ticker as plticker

DATE_COL = 'pred_dates'

df = pd.read_csv(JOURNAL_LOG)
df_net = df.groupby(GROUP_COLS)[METRIC].all()

# Delete rows w/o a real serial
df = df[df['Serial'] > 10]

plt.rcParams["figure.figsize"] = [18,6]
sns.barplot(x=df['Serial'], y=df[METRIC])
#plt.plot(df[COLS])
plt.xlabel('Serial')
plt.xticks(rotation=90)
plt.ylabel(METRIC)
plt.title(f'{METRIC} for all Serials')


TICK_SPACING=6
#MAX_GRAPHS=10
#num_graphs = (MAX_GRAPHS if df.shape[0] >= MAX_GRAPHS else df.shape[0])
#fig, axs = plt.subplots(num_graphs, 1, figsize=(9,(num_graphs*6)), layout="constrained")

#import matplotlib
#matplotlib.use('Qt5Agg')
#from display_window import DispApp
#disp = DispApp(fig)

for i,s in enumerate(df.index.values):
  cur_row = df.loc[s]
  serial = cur_row['Serial']
  if (serial <= 10):
    continue

  mse = round(float(cur_row['MSE']), 4)
  mae = round(float(cur_row['MAE']), 4)
  model = cur_row['Model']
  epochs = cur_row['NumEpochs']

  #if (mse > .021):
  #    continue

  if (serial != 674022):
    continue

  fig, ax = plt.subplots(1, 1, figsize=(11,5), layout="constrained")

  #print(f'Reading results for serial: {serial}')
  df_stats = pd.read_csv(DATA_ROOT + f'model-preds-{serial}.csv')
  # Save numeric index off, could be handy
  index=df_stats.index.values
  #...but drop it
  df_stats.drop(columns=['index'],inplace=True)
  df_stats.set_index('pred_dates', drop=True, inplace=True)

  # Plot the stats
  sns.lineplot(data=df_stats[['y_test','preds']], ax=ax)

  ax.set_xticks(df_stats.index, labels=df_stats.index, rotation=90)
  ax.xaxis.set_major_locator(plticker.MultipleLocator(TICK_SPACING))
  plt.xlabel('Time steps')
  plt.ylabel('Temp in degrees C')
  ax.legend(('Test','Predicted'))

  title_str = [f'{GROUP_COLS[t]}: {cur_row[GROUP_COLS[t]]}\n' for t in range(4)]
  title_str = ''.join(title_str)
  ax.set_title(f'({i}) Pred vs. Actual for Serial {serial}\n{title_str}')
  ax.annotate(f'Model: {model} MSE: {mse}   MAE: {mae} Epochs: {epochs}             ',
              xy=(1,1),  # point to annotate - see xycoords for units
              xytext=(50, 10),  # offset from xy - units in textcoords
              xycoords='axes fraction',  # how coords are translated?
              textcoords='offset pixels', # 'axes fraction', 'offset pixels'
              horizontalalignment='right'
              )
  plt.legend(df_stats.columns)

plt.show()
